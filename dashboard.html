<!DOCTYPE html>
<html>
<head>
  <title>DolphinNotBot Dashboard - servers</title>
  <link rel="shortcut icon" type="image/x-icon" href="images/favicon.ico?">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <div id="servers">
      Welcome to your DolphinNotBot dashboard!
    </div>
  </header>
  <main>
    <!-- The content related to the dashboard goes here -->
    <div id="subtitle">
      <!-- The rest of the content related to the dashboard -->

      <!-- Add a container for the server showcase -->
      <div id="server-showcase-container" style="display: none;">
        <h2 class="neon-text">Server Showcase</h2>
        <div class="server-list" id="server-list">
          <!-- The server list will be generated using JavaScript -->
        </div>
      </div>
    </div>

    <!-- Display user stats here -->
    <div id="user-stats">
      <h2 class="neon-text">User Stats</h2>
      <p id="user-username">Username: </p>
      <p id="user-tag">Tag: </p>
      <p id="user-servers">Servers Owned: </p>
    </div>

    <!-- "Login Again" button -->
    <button id="login-again" style="display: none;">Login Again</button>
  </main>
  <script>
    function generateRandomString() {
      let randomString = '';
      const randomNumber = Math.floor(Math.random() * 10);

      for (let i = 0; i < 20 + randomNumber; i++) {
        randomString += String.fromCharCode(33 + Math.floor(Math.random() * 94));
      }

      return randomString;
    }

    function getURLParameter(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    function fetchAndDisplayUserData() {
      const accessToken = getURLParameter('access_token');
      const tokenType = getURLParameter('token_type');
      const state = getURLParameter('state');

      if (!accessToken || !tokenType || !state) {
        const randomString = generateRandomString();
        localStorage.setItem('oauth-state', randomString);

        document.getElementById('login').href += `&state=${encodeURIComponent(
          btoa(randomString)
        )}`;
        return (document.getElementById('login').style.display = 'block');
      }

      if (localStorage.getItem('oauth-state') !== atob(decodeURIComponent(state))) {
        return console.log('You may have been click-jacked!');
      }

      fetch('https://discord.com/api/users/@me/guilds', {
        headers: {
          authorization: `${tokenType} ${accessToken}`,
        },
      })
        .then((result) => result.json())
        .then((response) => {
          const { username, discriminator } = response;

          // Display user stats
          document.getElementById('user-username').innerText += username;
          document.getElementById('user-tag').innerText += discriminator;
          document.getElementById('user-servers').innerText += response.length;

          // Show the server showcase container
          document.getElementById('server-showcase-container').style.display = 'block';

          // Enable the user to access dashboard.html by clicking on their username
          const clickableUsername = document.createElement('a');
          clickableUsername.textContent = `${username}#${discriminator}`;
          clickableUsername.href = './dashboard.html'; // Replace with the actual relative path to your dashboard.html
          document.getElementById('user-stats').appendChild(clickableUsername);

          // Show the "Login Again" button when the user is logged in
          document.getElementById('login-again').style.display = 'block';
        })
        .catch(console.error);
    }

    window.onload = () => {
      fetchAndDisplayUserData();

      // "Login Again" button event listener
      document.getElementById('login-again').addEventListener('click', () => {
        localStorage.removeItem('oauth-state');
        window.location.href = './index.html'; // Replace with the actual relative path to your index.html
      });
    };
  </script>
</body>
</html>
