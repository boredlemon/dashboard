<!DOCTYPE html>
<html>
<head>
  <title>DolphinNotBot Dashboard - servers</title>
  <link rel="shortcut icon" type="image/x-icon" href="images/favicon.ico?">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <!-- Welcome to your DolphinNotBot dashboard! -->
  </header>
  <main>
    <!-- The content related to the dashboard goes here -->
    <div id="subtitle">
      <!-- The rest of the content related to the dashboard -->

      <!-- Add a container for the server showcase -->
      <div id="server-showcase-container" style="display: none;">
        <h2 class="neon-text">Server Showcase</h2>
        <div class="server-list" id="server-list">
          <!-- The server list will be generated using JavaScript -->
        </div>
      </div>
    </div>
  </main>
  <script>
    function generateRandomString() {
      let randomString = '';
      const randomNumber = Math.floor(Math.random() * 10);

      for (let i = 0; i < 20 + randomNumber; i++) {
        randomString += String.fromCharCode(33 + Math.floor(Math.random() * 94));
      }

      return randomString;
    }

    async function fetchServers(accessToken) {
      try {
        const response = await fetch('https://discord.com/api/users/@me/guilds', {
          headers: {
            Authorization: `Bearer ${accessToken}`,
          },
        });

        if (!response.ok) {
          throw new Error(`${response.status}: ${response.statusText}`);
        }

        const serverList = await response.json();
        return serverList;
      } catch (error) {
        console.error('API Error:', error);
        return [];
      }
    }

    async function displayServers() {
      const fragment = new URLSearchParams(window.location.hash.slice(1));
      const accessToken = fragment.get('access_token');

      if (!accessToken) {
        console.error('Access token not found. Please log in first.');
        return;
      }

      const serverList = await fetchServers(accessToken);
      const serverShowcase = document.getElementById('server-list');

      serverShowcase.innerHTML = ''; // Clear existing content

      serverList.forEach((server) => {
        const serverName = document.createElement('p');
        serverName.innerText = `${server.name}`;
        serverShowcase.appendChild(serverName);
      });
    }

    window.onload = () => {
      const fragment = new URLSearchParams(window.location.hash.slice(1));
      const accessToken = fragment.get('access_token');

      if (!accessToken) {
        // Redirect the user to the authorization link
        const redirectURL = 'https://discord.com/oauth2/authorize?client_id=1125530042915631159&redirect_uri=https%3A%2F%2Fdolphinnotfound.github.io%2FDolphinNotBot-dashboard%2F&response_type=token&scope=identify%20guilds';
        window.location.replace(redirectURL);
        return; // Stop further execution until the redirection completes
      }

      if (localStorage.getItem('oauth-state') !== atob(decodeURIComponent(fragment.get('state')))) {
        return console.log('You may have been click-jacked!');
      }

      // If the user is logged in, display the server showcase container
      const serverShowcaseContainer = document.getElementById('server-showcase-container');
      serverShowcaseContainer.style.display = 'block';

      displayServers();
    };
  </script>
</body>
</html>
